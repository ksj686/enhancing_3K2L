<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/thymeleaf/default_layout}">
<th:block layout:fragment="css">
	<link rel="stylesheet" href="/css/diary/diary-view.css">
</th:block>

<body>
<div class="main-content" layout:fragment="content">
	<!-- title -->
	<div class="title-section">
		<span class="memberid" th:text="${diary.memberNickname}">ì•„ì´ë””</span>
		<img src="/img/journal/diary-sjournal.png" class="diary-journal" />
	</div>

	<div class="content-wrapper">

		<div class="content-section">
		<!-- ğŸ“Œ ìº˜ë¦°ë” ì»¨í…Œì´ë„ˆ -->
			<div class="calendar-section">
            	<div id="calendar-container">
        			<!-- ë“œë¡­ë‹¤ìš´ ì»¨íŠ¸ë¡¤ -->
        			<div id="controls">
            			<select id="year-select"></select>
            			<select id="month-select">
                			<option value="0">January</option>
                			<option value="1">February</option>
                			<option value="2">March</option>
                			<option value="3">April</option>
                			<option value="4">May</option>
                			<option value="5">June</option>
                			<option value="6">July</option>
                			<option value="7">August</option>
                			<option value="8">September</option>
                			<option value="9">October</option>
                			<option value="10">November</option>
                			<option value="11">December</option>
            			</select>
        			</div>
			
					<!-- ìº˜ë¦°ë” -->
        			<div id="calendar"></div>
    			</div>
			</div>
		</div>

		<div class="diary-button-section">
			<div class="diary-section">
				<!-- <img src="/img/journal/diary_read.png" class="diary_book" /> -->
				<!-- ì¼ê¸° ì œëª© & ë‚ ì§œ -->
				<div class="diary-container">
					<div class="diary-header" id="diary-header">
						<p th:text="${diary.diaryTitle}"></p>
					</div>
					<div class="diary-date">
						<p class="diary-date">DATE:
							<span id="diary-date"
								  th:text="${diary.diaryDate != null ? diary.diaryDate.substring(0,10) : 'ë‚ ì§œ ì—†ìŒ'}"></span>
						</p>
					</div>

					<!-- ì¼ê¸° ë‚´ìš© -->
					<div class="diary-content">
						<p th:utext="${diary.diaryContent}"></p>
						<!-- ì²¨ë¶€íŒŒì¼ì´ ì¡´ì¬í•  ê²½ìš° -->
						<div class="attach-file" th:if="${attach != null}">
							<!-- íŒŒì¼ í™•ì¥ì í™•ì¸ -->
							<div th:with="extension=${attach.getFileExtension()}">

								<!-- ì´ë¯¸ì§€ íŒŒì¼ì¸ ê²½ìš° -->
								<div th:if="${extension == 'jpg' or extension == 'jpeg' or extension == 'png' or extension == 'gif'}">
									<img th:src="@{/attach/{fileName}(fileName=${attach.attachName})}" alt="ì²¨ë¶€ ì´ë¯¸ì§€"/>
								</div>

								<!-- ê¸°íƒ€ íŒŒì¼ì¸ ê²½ìš° -->
								<div th:unless="${extension == 'jpg' or extension == 'jpeg' or extension == 'png' or extension == 'gif'}">
									<a th:href="@{/attach/{fileName}(fileName=${attach.attachName})}"
									   th:text="${attach.attachName}" download>
										<button>ğŸ“¥ íŒŒì¼ ë‹¤ìš´ë¡œë“œ</button>
									</a>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- í”¼ë“œë°± -->
				<div class="feed-container">
					<h3 id="diaryEmotion" th:text="${diary.diaryEmotion != null ? diary.diaryEmotion:'â³ í”¼ë“œë°±ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...'}"></h3>
<!--					<p id="diaryFeedback" th:text="${diary.diaryEmotion}?:'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...'"-->
					<p id="diaryFeedback" style="text-align:left">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...</p>
				</div>
			</div>

			<!-- ë²„íŠ¼ -->
			<div class="update-delete-container">
				<button class="update-btn" th:onclick="|location.href='@{/diary/update(diaryId=${diary.diaryId})}'|">ìˆ˜ì •</button>
				<button class="delete-btn" th:onclick="|if(confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { location.href='@{/diary/delete(diaryId=${diary.diaryId})}'; }|">ì‚­ì œ</button>
			</div>
		</div>
	</div>
</div>

<th:block layout:fragment="script">
	<!-- FullCalendar JS -->
	<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.8/index.global.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.8/index.global.min.js"></script>
	<script type="text/javascript" th:src="@{/js/diary/getFeedbackMessage.js}"></script>

	<!-- Custom JS -->
	<script>
		document.addEventListener('DOMContentLoaded', function() {
			const calendarEl = document.getElementById('calendar');

			// FullCalendar ì´ˆê¸°í™”
			const calendar = new FullCalendar.Calendar(calendarEl, {
				initialView: 'dayGridMonth',
				locale: 'en', // ì˜ì–´ ì„¤ì •
				headerToolbar: false, // ê¸°ë³¸ í—¤ë” íˆ´ë°” ì œê±°
				dayHeaderContent: (args) => args.text.substr(0, 3), // ìš”ì¼ ì´ë¦„ì„ ì• ì„¸ ê¸€ìë¡œ í‘œì‹œ
				events: [], // ì´ë²¤íŠ¸ ì—†ìŒ
				aspectRatio: 1.35, // ê¸°ì¡´ë³´ë‹¤ ë„“ì–´ì§€ê²Œ ì¡°ì •
				contentHeight: 'auto' // ìë™ ë†’ì´ ì¡°ì •
			});

			calendar.render();

			// ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
			const yearSelect = document.getElementById('year-select');
			const monthSelect = document.getElementById('month-select');

			const currentYear = new Date().getFullYear();

			// ë…„ë„ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸° (í˜„ì¬ ë…„ë„ ê¸°ì¤€ Â±5ë…„)
			for (let i = currentYear - 5; i <= currentYear + 5; i++) {
				const option = document.createElement('option');
				option.value = i;
				option.textContent = `${i} ë…„`;
				if (i === currentYear) option.selected = true; // í˜„ì¬ ë…„ë„ ì„ íƒ
				yearSelect.appendChild(option);
			}

			// ì›” ë“œë¡­ë‹¤ìš´ ì´ˆê¸°ê°’ ì„¤ì •
			monthSelect.value = new Date().getMonth();

			// ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
			function updateCalendar() {
				const selectedYear = parseInt(yearSelect.value);
				const selectedMonth = parseInt(monthSelect.value);

				// ì„ íƒëœ ë…„ë„ì™€ ì›”ë¡œ ì´ë™
				calendar.gotoDate(new Date(selectedYear, selectedMonth));
			}

			yearSelect.addEventListener('change', updateCalendar);
			monthSelect.addEventListener('change', updateCalendar);



			// AI í”¼ë“œë°± ì²˜ë¦¬
			const feedContainer = document.querySelector(".feed-container");
			const diaryEmotion = document.getElementById("diaryEmotion");
			const diaryFeedback = document.getElementById("diaryFeedback");

			function fetchEmotion(diaryId) {
				fetch(`/api/diary/emotion/${diaryId}`) // í”¼ë“œë°± ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¬ API ì—”ë“œí¬ì¸íŠ¸
					.then(response => {
						if (!response.ok) {
							throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µì´ ì¢‹ì§€ ì•ŠìŠµë‹ˆë‹¤.');
						}
						return response.json(); // JSON í˜•íƒœë¡œ ì‘ë‹µì„ ë³€í™˜
					})
					.then(data => {
						// console.log(data.emotion);
						const feedback = getFeedbackMessage(data.emotion);

						diaryEmotion.textContent = data.emotion;
						diaryFeedback.textContent = feedback.message;
						feedContainer.style.backgroundColor = feedback.backgroundColor;
					})
					.catch(error => {
						console.error('í”¼ë“œë°±ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
					});
			}


			// í”¼ë“œë°± ê²°ê³¼ë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ í™•ì¸
			const intervalId = setInterval(() => {
				if (!diaryFeedback.textContent.includes("ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”")) {
					clearInterval(intervalId); // í”¼ë“œë°±ì´ ìƒì„±ë˜ë©´ ì£¼ê¸°ì  í™•ì¸ ì¤‘ì§€
				} else {
					const diaryId = [[ ${diary.diaryId} ]];
					fetchEmotion(diaryId); // í”¼ë“œë°± ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ í˜¸ì¶œ
				}
			}, 1000); // 5ì´ˆë§ˆë‹¤ í™•ì¸



		});
	</script>
	<!--
	<script>
		document.addEventListener("DOMContentLoaded", function() {
			const diaryFeedback = document.getElementById("diaryFeedback");

			// ë§Œì•½ ë°±ì—”ë“œì—ì„œ ë°ì´í„°ë¥¼ ì•„ì§ ì œê³µí•˜ì§€ ì•Šì•˜ë‹¤ë©´, ë¡œë”© ì•ŒëŸ¿ í‘œì‹œ
			if (diaryFeedback.textContent.includes("í”¼ë“œë°±ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤")) {
				alert("í”¼ë“œë°±ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...");
			}
		});
	</script>
	-->
</th:block>
</body>
</html>