<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>JOURNIVERSE | DIARY LIST</title>

    <!-- âœ… TUI Calendar CSS -->
    <link rel="stylesheet" href="https://uicdn.toast.com/tui-calendar/latest/tui-calendar.min.css">
    <link rel="stylesheet" href="/css/diary/diary-datelist.css">

    <!-- âœ… í•„ìˆ˜ JS ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://uicdn.toast.com/tui.code-snippet/latest/tui-code-snippet.min.js"></script>
    <script src="https://uicdn.toast.com/tui-calendar/latest/tui-calendar.min.js"></script>
</head>

<body>    
    <div class="container">
        <!-- ğŸ“Œ ìƒë‹¨ ì—°ë„ ì„ íƒ -->
        <h2><span th:text="${nickname}"></span> ì˜ 
            <select id="yearSelect">
                <option th:each="y : ${#numbers.sequence(2020, 2030)}"
                        th:value="${y}" th:text="${y} + 'ë…„'"
                        th:selected="${y == year}"></option>
            </select> Journal
        </h2>

        <div class="content">
            <!-- ğŸ“Œ ìº˜ë¦°ë” ì»¨í…Œì´ë„ˆ -->
            <div class="calendar-wrapper">
                <select id="monthSelect">
                    <option th:each="m : ${#numbers.sequence(1, 12)}"
                            th:value="${m}" th:text="${m} + 'ì›”'"
                            th:selected="${m == month}"></option>
                </select>
                <div id="calendar"></div>
            </div>

            <!-- ğŸ“Œ ë…¸íŠ¸ ìŠ¤íƒ€ì¼ ì¼ê¸°ì¥ -->
            <div class="diary-book">
                <div class="diary-header">
                    <h3 id="diary-title">í–‰ë³µí•œ ì˜¤ëŠ˜!</h3>
                    <p id="diary-date">DATE: <span></span></p>
                </div>
                <div class="diary-content">
                    <p id="diary-text">ì„ íƒí•œ ì¼ê¸°ì˜ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
                <div class="diary-footer">
                    <button class="edit-btn" id="editDiaryBtn">ìˆ˜ì •</button>
                    <button class="delete-btn" id="deleteDiaryBtn">ì‚­ì œ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const yearSelect = document.getElementById("yearSelect");
            const monthSelect = document.getElementById("monthSelect");
            let currentYear = parseInt(yearSelect.value);
            let currentMonth = parseInt(monthSelect.value);
            let selectedDiaryId = null;

            // âœ… TUI ìº˜ë¦°ë” ì´ˆê¸°í™”
            let calendar = new tui.Calendar("#calendar", {
                defaultView: "month",
                useCreationPopup: false,
                useDetailPopup: false,
            });

            // ğŸ“Œ ì„ íƒëœ ì—°/ì›” ìœ ì§€í•˜ë©´ì„œ ë°ì´í„° ë¡œë“œ
            function loadDiaryData(year, month) {
                fetch(`/diary/list?year=${year}&month=${month}`)
                    .then(response => response.json())
                    .then(data => {
                        calendar.clear();
                        data.forEach(diary => {
                            calendar.createSchedules([{
                                id: diary.diaryId,
                                calendarId: "1",
                                title: diary.diaryTitle,
                                category: "allday",
                                start: diary.diaryDate,
                                bgColor: getEmotionColor(diary.diaryEmotion),
                                borderColor: getEmotionColor(diary.diaryEmotion),
                            }]);
                        });
                    })
                    .catch(error => console.error("ì¼ê¸° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í•¨:", error));
            }

            // ğŸ“Œ ê°ì •ì— ë”°ë¥¸ ë°°ê²½ ìƒ‰ìƒ
            function getEmotionColor(emotion) {
                const colorMap = {
                    "ê¸°ì¨": "#FFD700",
                    "ìŠ¬í””": "#4682B4",
                    "ë¶„ë…¸": "#FF6347",
                    "ë‹¹í™©": "#8A2BE2",
                    "ë¶ˆì•ˆ": "#20B2AA",
                    "ì¤‘ë¦½": "#A9A9A9"
                };
                return colorMap[emotion] || "#D3D3D3";
            }

            // ğŸ“Œ ìº˜ë¦°ë”ì—ì„œ íŠ¹ì • ë‚ ì§œ í´ë¦­ ì‹œ ì¼ê¸° ë¡œë“œ
            calendar.on("clickSchedule", function(event) {
                selectedDiaryId = event.schedule.id;
                fetch(`/diary/${selectedDiaryId}`)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById("diary-title").innerText = data.diaryTitle;
                        document.getElementById("diary-date").innerText = `DATE: ${data.diaryDate}`;
                        document.getElementById("diary-text").innerText = data.diaryContent || "ë‚´ìš© ì—†ìŒ";
                    })
                    .catch(error => console.error("ì¼ê¸° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í•¨:", error));
            });

            // ğŸ“Œ ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ í•´ë‹¹ ì¼ê¸° ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™
            document.getElementById("editDiaryBtn").addEventListener("click", function() {
                if (selectedDiaryId) {
                    window.location.href = `/diary/update?diaryId=${selectedDiaryId}`;
                }
            });

            // ğŸ“Œ ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ ì¼ê¸° ì‚­ì œ
            document.getElementById("deleteDiaryBtn").addEventListener("click", function() {
                if (selectedDiaryId && confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    window.location.href = `/diary/delete?diaryId=${selectedDiaryId}`;
                }
            });

            // ğŸ“Œ ì—°ë„/ì›” ë³€ê²½ ì‹œ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
            function updateCalendar() {
                currentYear = parseInt(yearSelect.value);
                currentMonth = parseInt(monthSelect.value);
                calendar.setDate(new Date(currentYear, currentMonth - 1, 1));
                loadDiaryData(currentYear, currentMonth);
            }

            yearSelect.addEventListener("change", updateCalendar);
            monthSelect.addEventListener("change", updateCalendar);

            // âœ… ì´ˆê¸° ë°ì´í„° ë¡œë“œ
            loadDiaryData(currentYear, currentMonth);
            calendar.render();
        });
    </script>
</body>
</html>
