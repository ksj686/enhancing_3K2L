<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>JOURNIVERSE | DIARY LIST</title>
    
    <!-- âœ… TUI Calendar CSS -->
    <link rel="stylesheet" href="https://uicdn.toast.com/tui-calendar/latest/tui-calendar.min.css">

    <!-- âœ… í•„ìˆ˜ JS ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://uicdn.toast.com/tui.code-snippet/latest/tui-code-snippet.min.js"></script>
    <script src="https://uicdn.toast.com/tui-calendar/latest/tui-calendar.min.js"></script>

    <link rel="stylesheet" href="/css/diary/diary-list.css">
</head>

<body>    
    <div class="container">
        <!-- ğŸ“Œ ìº˜ë¦°ë” ì»¨í…Œì´ë„ˆ -->
        <div class="calendar-wrapper">
            <div class="calendar-header">
                <select id="monthSelect"></select>
                <select id="yearSelect"></select>
            </div>
            <div id="calendar"></div>
        </div>

        <!-- ğŸ“Œ ë…¸íŠ¸ ìŠ¤íƒ€ì¼ì˜ ì¼ê¸° ë³´ê¸° ì˜ì—­ -->
        <div class="diary-view">
            <h2 class="diary-title">ì¼ê¸°ë¥¼ ì„ íƒí•˜ì„¸ìš”</h2>
            <p class="diary-content">ì„ íƒí•œ ì¼ê¸°ì˜ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
            <p class="diary-date"></p>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            console.log("DOMContentLoaded ì‹¤í–‰ë¨");

            if (typeof tui.Calendar === 'undefined') {
                console.error("ğŸš¨ TUI Calendar ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•ŠìŒ!");
                return;
            }

            // âœ… ë…„ë„ì™€ ì›” ì„ íƒì„ ìœ„í•œ select ë°•ìŠ¤ ì„¤ì •
            const yearSelect = document.getElementById("yearSelect");
            const monthSelect = document.getElementById("monthSelect");

            let currentYear = new Date().getFullYear();
            let currentMonth = new Date().getMonth() + 1;

            for (let y = 2020; y <= 2030; y++) {
                let option = document.createElement("option");
                option.value = y;
                option.textContent = y + " ë…„";
                if (y === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }

            for (let m = 1; m <= 12; m++) {
                let option = document.createElement("option");
                option.value = m;
                option.textContent = m + " ì›”";
                if (m === currentMonth) option.selected = true;
                monthSelect.appendChild(option);
            }

            var cal = new tui.Calendar("#calendar", {
                defaultView: "month",
                useCreationPopup: false,
                useDetailPopup: false,
            });

            // ğŸ“Œ ë…„ë„/ì›” ì„ íƒ ì‹œ ë‹¬ë ¥ ì—…ë°ì´íŠ¸
            function setMonthYear() {
                let selectedYear = yearSelect.value;
                let selectedMonth = monthSelect.value;
                cal.setDate(new Date(selectedYear, selectedMonth - 1, 1));
                loadDiaryData(selectedYear, selectedMonth);
            }

            yearSelect.addEventListener("change", setMonthYear);
            monthSelect.addEventListener("change", setMonthYear);

            // ğŸ“Œ ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ì¼ê¸° í‘œì‹œ
            function loadDiaryData(year, month) {
                fetch(`/diary/list?year=${year}&month=${month}`)
                    .then(response => response.json())
                    .then(data => {
                        cal.clear(); // ê¸°ì¡´ ì¼ì • ì´ˆê¸°í™”

                        data.forEach(diary => {
                            cal.createSchedules([
                                {
                                    id: diary.diaryId,
                                    calendarId: "1",
                                    title: diary.diaryTitle,
                                    category: "allday",
                                    start: diary.diaryDate,
                                    color: "#ffffff",
                                    bgColor: getEmotionColor(diary.diaryEmotion),
                                    borderColor: getEmotionColor(diary.diaryEmotion),
                                }
                            ]);
                        });
                    })
                    .catch(error => console.error("ì¼ê¸° ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error));
            }

            // ğŸ“Œ diaryEmotion ê°’ì— ë”°ë¼ ìƒ‰ìƒ ì„¤ì •
            function getEmotionColor(emotion) {
                const colorMap = {
                    "ê¸°ì¨": "#FFD700",
                    "ìŠ¬í””": "#4682B4",
                    "ë¶„ë…¸": "#FF6347",
                    "ë‹¹í™©": "#8A2BE2",
                    "ë¶ˆì•ˆ": "#20B2AA",
                    "ì¤‘ë¦½": "#A9A9A9"
                };
                return colorMap[emotion] || "#D3D3D3"; // ê¸°ë³¸ ìƒ‰ìƒ: íšŒìƒ‰
            }

            // ğŸ“Œ ì¼ê¸° í´ë¦­ ì‹œ, ì˜¤ë¥¸ìª½ ì˜ì—­ì— ë‚´ìš© í‘œì‹œ
            cal.on("clickSchedule", function(event) {
    			let clickedDate = event.schedule.start.toISOString().split("T")[0]; // ğŸ“Œ "YYYY-MM-DD" í˜•ì‹ìœ¼ë¡œ ë³€í™˜

    			console.log("ğŸ“… í´ë¦­í•œ ë‚ ì§œ:", clickedDate);

    			fetch(`/diary/${clickedDate}`)
        			.then(response => response.json())
        			.then(data => {
            			document.querySelector(".diary-title").innerText = data.diaryTitle;
            			document.querySelector(".diary-content").innerText = data.diaryContent || "ë‚´ìš© ì—†ìŒ";
            			document.querySelector(".diary-date").innerText = `DATE: ${data.diaryDate}`;
        			})
        			.catch(error => console.error("ì¼ê¸° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í•¨:", error));
			});


            // âœ… ì´ˆê¸° ë°ì´í„° ë¡œë“œ
            loadDiaryData(currentYear, currentMonth);
            cal.render();
        });
    </script>
</body>
</html>
